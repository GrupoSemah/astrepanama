---
import { getImageUrl } from "@/services/cloudStorage";
import Carousel from "../ui/Carousel.astro";

interface Props {
  title?: string;
}

const { title = "Amenidades" } = Astro.props;

const amenidades = [
  {
    title: "Piscina",
    description: "Relájate con estilo, rodeado de paisajismo moderno",
    icon: "/icons/svg/pool.svg"
  },
  {
    title: "Sala de fiestas",
    description: "Ideal para celebraciones privadas y momentos especiales",
    icon: "/icons/svg/salon.svg"
  },
  {
    title: "Área infantil",
    description: "Un espacio seguro y divertido para los más pequeños",
    icon: "/icons/svg/areainfantil.svg"
  },
  {
    title: "Cancha de Basket",
    description: "Perfecto para liberar energía y mantenerte activo",
    icon: "/icons/svg/cancha.svg"
  },
  {
    title: "Gimnasio",
    description: "Equipado para entrenamientos funcionales y de fuerza",
    icon: "/icons/svg/gym.svg"
  },
  {
    title: "Game room",
    description: "Diversión para toda la familia sin salir de casa",
    icon: "/icons/svg/game.svg"
  }
];

const currentAmenity = amenidades[0];
const imageFolder = "AMENIDADES";
const imageNames = [
  "Amenidades_imagenes-01.webp",
  "Amenidades_imagenes-02.webp",
  "Amenidades_imagenes-03.webp",
  "Amenidades_imagenes-04.webp",
  "Amenidades_imagenes-05.webp",
  "Amenidades_imagenes-06.webp"
];

const poolImages = imageNames.map(name => getImageUrl(name, imageFolder));
---

<section
  id="amenidades"
  class="md:min-h-screen w-full flex flex-col items-center justify-center bg-white md:py-24"
>
  <div class="text-center mb-14 md:mb-16 px-4">
    <h2 class="text-4xl md:text-5xl font-bold text-primary mb-4" style="font-family: var(--font-heading);">
      Comodidades que transforman tu rutina
    </h2>
    <p class="text-base md:text-lg text-primary opacity-90 max-w-3xl mx-auto" style="font-family: var(--font-body);">
      PH Astre ofrece una selección de amenidades diseñadas para tu bienestar, recreación y estilo de vida activo.
    </p>
  </div>

  <!-- Versión Móvil -->
  <div class="w-full md:hidden min-h-[90vh] flex flex-col justify-between py-8">
    <div class="container mx-auto px-4 flex-grow flex flex-col">
      <!-- Ícono, Título y descripción centrados -->
      <div class="text-center mb-4">
        <div class="flex justify-center mb-4 transform transition-all duration-500 rotate-x-0 perspective-500" id="amenity-icon-container-mobile">
          <img
            src={currentAmenity.icon}
            alt={`Icono de ${currentAmenity.title}`}
            class="w-22 h-22"
            id="amenity-icon-mobile"
          />
        </div>
        <h2
          class="text-5xl font-bold text-[#222222] mb-2 transform transition-all duration-500 rotate-x-0 perspective-500 whitespace-nowrap" 
          id="amenity-title-mobile"
          style="font-family: var(--font-heading);"
        >
          {currentAmenity.title}
        </h2>
        <p
          class="text-xl text-[#222222] opacity-80 transform transition-all duration-500 rotate-x-0 perspective-500"
          id="amenity-description-mobile"
          style="font-family: var(--font-body);"
        >
          {currentAmenity.description}
        </p>
      </div>

      <!-- Carousel con imágenes -->
      <div class="flex-grow mb-4 flex flex-col justify-center">
        <div class="relative">
          <Carousel
            images={poolImages}
            id="pool-carousel-mobile"
            class="rounded-3xl overflow-hidden aspect-[16/10]"
          />
        </div>

        <!-- Puntos de navegación para móvil -->
        <div class="custom-carousel-dots flex justify-center mt-6 gap-3" id="mobile-carousel-dots">
          {amenidades.map((_, index) => (
            <button
              class={`carousel-dot w-3 h-3 rounded-full bg-primary ${index === 0 ? 'opacity-100' : 'opacity-40'}`}
              data-index={index}
              aria-label={`Ir a amenidad ${index + 1}`}
            ></button>
          ))}
        </div>
      </div>
    </div>
  </div>

  <div class="hidden md:block w-full">
    <div class="container mx-auto px-8">
      <div class="grid grid-cols-2 gap-20 place-content-center">
        <div>
          <div class="flex justify-center mb-6 transform transition-all duration-500 rotate-x-0 perspective-500" id="amenity-icon-container-desktop">
            <img
              src={currentAmenity.icon}
              alt={`Icono de ${currentAmenity.title}`}
              class="w-32 h-32"
              id="amenity-icon-desktop"
            />
          </div>

          <!-- Título y descripción -->
          <h2
            class="text-6xl text-center font-bold text-primary mb-3 transform transition-all duration-500 rotate-x-0 perspective-500 whitespace-nowrap"
            style="font-family: var(--font-heading);"
            id="amenity-title-desktop"
          >
            {currentAmenity.title}
          </h2>
          <p
            class="text-xl text-center text-primary opacity-80 mb-8 max-w-lg mx-auto transform transition-all duration-500 rotate-x-0 perspective-500"
            style="font-family: var(--font-body);"
            id="amenity-description-desktop"
          >
            {currentAmenity.description}
          </p>
        </div>

        <!-- Columna derecha con carousel -->
        <div class="relative">
          <Carousel
            images={poolImages}
            id="pool-carousel-desktop"
            class="rounded-3xl overflow-hidden aspect-[16/10]"
          />
        </div>
      </div>
    </div>

    <!-- Puntos de navegación para desktop -->
    <div class="flex justify-center mt-10 gap-4" id="desktop-carousel-dots">
      {amenidades.map((_, index) => (
        <button
          class={`carousel-dot w-3 h-3 rounded-full cursor-pointer bg-primary ${index === 0 ? 'opacity-100' : 'opacity-40'} hover:opacity-70 transition-opacity`}
          data-index={index}
          aria-label={`Ir a amenidad ${index + 1}`}
        ></button>
      ))}
    </div>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const amenidades = [
      {
        title: "Piscina",
        description: "Relájate con estilo, rodeado de paisajismo moderno",
        icon: "/icons/svg/pool.svg"
      },
      {
        title: "Sala de fiestas",
        description: "Ideal para celebraciones privadas y momentos especiales",
        icon: "/icons/svg/salon.svg"
      },
      {
        title: "Área infantil",
        description: "Un espacio seguro y divertido para los más pequeños",
        icon: "/icons/svg/areainfantil.svg"
      },
      {
        title: "Cancha de Basket",
        description: "Perfecto para liberar energía y mantenerte activo",
        icon: "/icons/svg/cancha.svg"
      },
      {
        title: "Gimnasio",
        description: "Equipado para entrenamientos funcionales y de fuerza",
        icon: "/icons/svg/gym.svg"
      },
      {
        title: "Game room",
        description: "Diversión para toda la familia sin salir de casa",
        icon: "/icons/svg/game.svg"
      }
    ];

    let currentMobileIndex = 0;
    let currentDesktopIndex = 0;

    const titleMobile = document.getElementById('amenity-title-mobile');
    const descriptionMobile = document.getElementById('amenity-description-mobile');
    const iconMobile = document.getElementById('amenity-icon-mobile') as HTMLImageElement;
    const iconContainerMobile = document.getElementById('amenity-icon-container-mobile');
    
    const iconDesktop = document.getElementById('amenity-icon-desktop') as HTMLImageElement;
    const titleDesktop = document.getElementById('amenity-title-desktop');
    const descriptionDesktop = document.getElementById('amenity-description-desktop');
    const iconContainerDesktop = document.getElementById('amenity-icon-container-desktop');
    
    // Selectores para los nuevos puntos de navegación
    const mobileCarouselDots = document.getElementById('mobile-carousel-dots');
    const desktopCarouselDots = document.getElementById('desktop-carousel-dots');
    
    // Función para actualizar los puntos activos
    const updateDots = (index: number, isMobile: boolean): void => {
      const dots = isMobile ? 
        mobileCarouselDots?.querySelectorAll('.carousel-dot') : 
        desktopCarouselDots?.querySelectorAll('.carousel-dot');
      
      if (dots) {
        dots.forEach((dot, i) => {
          if (i === index) {
            dot.classList.add('opacity-100');
            dot.classList.remove('opacity-40');
          } else {
            dot.classList.add('opacity-40');
            dot.classList.remove('opacity-100');
          }
        });
      }
    };
    
    // Función para animar la transición con flip vertical
    const animateTransition = (isMobile: boolean): void => {
      // Elementos a animar
      const iconContainer = isMobile ? iconContainerMobile : iconContainerDesktop;
      const title = isMobile ? titleMobile : titleDesktop;
      const description = isMobile ? descriptionMobile : descriptionDesktop;
      
      // Aplicar animación de flip saliendo (rotación en X)
      if (iconContainer) iconContainer.classList.add('rotate-x-90', 'opacity-50');
      if (title) title.classList.add('rotate-x-90', 'opacity-50');
      if (description) description.classList.add('rotate-x-90', 'opacity-50');
      
      // Esperar brevemente y aplicar la animación de entrada
      setTimeout(() => {
        if (iconContainer) {
          iconContainer.classList.remove('rotate-x-90', 'opacity-50');
          iconContainer.classList.add('rotate-x-0', 'opacity-100');
        }
        if (title) {
          title.classList.remove('rotate-x-90', 'opacity-50');
          title.classList.add('rotate-x-0', 'opacity-100');
        }
        if (description) {
          description.classList.remove('rotate-x-90', 'opacity-50');
          description.classList.add('rotate-x-0', 'opacity-100');
        }
      }, 300);
    };
    
    const updateInfo = (index: number, isMobile: boolean): void => {
      if (index >= 0 && index < amenidades.length) {
        const amenidad = amenidades[index];
        
        if (isMobile) {
          currentMobileIndex = index;
        } else {
          currentDesktopIndex = index;
        }
        
        // Animar la transición
        animateTransition(isMobile);
        
        setTimeout(() => {
          if (isMobile && titleMobile && descriptionMobile) {
            titleMobile.textContent = amenidad.title;
            descriptionMobile.textContent = amenidad.description;
            
            if (iconMobile) {
              iconMobile.src = amenidad.icon;
              iconMobile.alt = `Icono de ${amenidad.title}`;
            }
          }
          
          if (!isMobile && iconDesktop && titleDesktop && descriptionDesktop) {
            iconDesktop.src = amenidad.icon;
            iconDesktop.alt = `Icono de ${amenidad.title}`;
            titleDesktop.textContent = amenidad.title;
            descriptionDesktop.textContent = amenidad.description;
          }
        }, 150); // Tiempo para que se complete la animación de salida
        
        // Actualizar puntos activos
        updateDots(index, isMobile);
      }
    };

    // Configurar evento de clic para puntos de navegación móvil
    if (mobileCarouselDots) {
      const mobileDots = mobileCarouselDots.querySelectorAll('.carousel-dot');
      mobileDots.forEach((dot, index) => {
        dot.addEventListener('click', () => {
          // Actualizar el carousel
          const carouselSlide = document.querySelector('#pool-carousel-mobile .carousel-track');
          if (carouselSlide && carouselSlide instanceof HTMLElement) {
            const slideWidth = document.querySelector('#pool-carousel-mobile')?.clientWidth || 0;
            carouselSlide.style.transform = `translateX(-${index * slideWidth}px)`;
          }
          
          // Actualizar info y puntos activos
          updateInfo(index, true);
          
          // Disparar evento para mantener sincronización con el carousel
          const event = new CustomEvent('carousel-dot-clicked', {
            bubbles: true,
            detail: { index }
          });
          mobileCarouselDots.dispatchEvent(event);
        });
      });
    }
    
    // Configurar evento de clic para puntos de navegación desktop
    if (desktopCarouselDots) {
      const desktopDots = desktopCarouselDots.querySelectorAll('.carousel-dot');
      desktopDots.forEach((dot, index) => {
        dot.addEventListener('click', () => {
          // Actualizar el carousel
          const carouselSlide = document.querySelector('#pool-carousel-desktop .carousel-track');
          if (carouselSlide && carouselSlide instanceof HTMLElement) {
            const slideWidth = document.querySelector('#pool-carousel-desktop')?.clientWidth || 0;
            carouselSlide.style.transform = `translateX(-${index * slideWidth}px)`;
          }
          
          // Actualizar info y puntos activos
          updateInfo(index, false);
          
          // Disparar evento para mantener sincronización con el carousel
          const event = new CustomEvent('carousel-dot-clicked', {
            bubbles: true,
            detail: { index }
          });
          desktopCarouselDots.dispatchEvent(event);
        });
      });
    }

    // Escuchar eventos del carousel para sincronizar con puntos
    const carouselMobile = document.getElementById('pool-carousel-mobile');
    if (carouselMobile) {
      // Escuchamos ambos eventos para mayor compatibilidad
      ['carousel-slide-changed', 'slide-changed'].forEach(eventName => {
        carouselMobile.addEventListener(eventName, ((e: Event) => {
          const customEvent = e as CustomEvent<{index: number}>;
          const index = customEvent.detail.index;
          if (currentMobileIndex !== index) {
            currentMobileIndex = index;
            updateInfo(currentMobileIndex, true);
            // Actualizamos los puntos de navegación
            updateDots(index, true);
          }
        }) as EventListener);
      });
    }

    const carouselDesktop = document.getElementById('pool-carousel-desktop');
    if (carouselDesktop) {
      ['carousel-slide-changed', 'slide-changed'].forEach(eventName => {
        carouselDesktop.addEventListener(eventName, ((e: Event) => {
          const customEvent = e as CustomEvent<{index: number}>;
          const index = customEvent.detail.index;
          if (currentDesktopIndex !== index) {
            currentDesktopIndex = index;
            updateInfo(currentDesktopIndex, false);
            updateDots(index, false);
          }
        }) as EventListener);
      });
    }
  });
</script>

<style>
  /* Ocultar los botones originales del carousel */
  :global(#pool-carousel-mobile .carousel-prev),
  :global(#pool-carousel-mobile .carousel-next),
  :global(#pool-carousel-desktop .carousel-prev),
  :global(#pool-carousel-desktop .carousel-next) {
    display: none !important;
  }

  /* Ocultar los indicadores de posición (dots) */
  :global(.carousel-container .carousel-dot) {
    display: none !important;
  }

  :global(#amenities-section .carousel-slide) {
    overflow: hidden;
  }

  /* Estilos para animación flip */
  .perspective-500 {
    perspective: 500px;
    transform-style: preserve-3d;
    backface-visibility: hidden;
  }

  .rotate-x-0 {
    transform: rotateX(0deg);
  }

  .rotate-x-90 {
    transform: rotateX(90deg);
  }
</style>
